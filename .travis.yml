language: python
services:
  - docker

jobs:
  include:
    - stage: test
      name: Integration Tests
      script: NODE_VERSION=$(cat .nvmrc) PYTHON_VERSION=$(cat .python-version) docker-compose run itests npm run itests
    - name: Backend Unit Tests
      script: |
        set -ex
        cd backend
        docker build -t webpi-backend:latest --file dev.Dockerfile --build-arg PYTHON_VERSION=$(cat ../.python-version) .
        docker run -i webpi-backend:latest pytest
        docker run -i webpi-backend:latest pylint -j0 webpi tests
        docker run -i webpi-backend:latest black --check webpi tests
        set +x
    - name: Frontend Unit Tests
      script: |
        set -ex
        cd frontend
        docker build -t webpi-frontend:latest --file dev.Dockerfile --build-arg NODE_VERSION=$(cat ../.nvmrc) .
        docker run -e CI=true -i webpi-frontend:latest npm test -- --coverage
        docker run -i webpi-frontend:latest npm run --silent check-fmt
        set +x
